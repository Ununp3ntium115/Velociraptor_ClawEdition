# GitHub Actions workflow for building and testing the macOS application
name: macOS Build and Test

on:
  push:
    branches:
      - main
      - 'cursor/*'
    paths:
      - 'apps/macos-app/**'
      - 'VelociraptorMacOS/**'
      - '.github/workflows/macos-build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/macos-app/**'
      - 'VelociraptorMacOS/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release build'
        required: false
        default: false
        type: boolean

env:
  XCODE_VERSION: '15.0'
  MACOS_DEPLOYMENT_TARGET: '13.0'
  APP_NAME: 'Velociraptor'
  BUNDLE_ID: 'com.velocidex.velociraptor'
  VERSION: '5.0.5'

jobs:
  build:
    name: Build macOS App
    runs-on: macos-14
    outputs:
      build_path: ${{ steps.build.outputs.build_path }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Show build environment
        run: |
          echo "Xcode version:"
          xcodebuild -version
          echo "Swift version:"
          swift --version
          echo "macOS version:"
          sw_vers
        
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Xcode Project
        working-directory: apps/macos-app
        run: |
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Project generated successfully"
          ls -la *.xcodeproj || echo "No xcodeproj found"
        
      - name: Build macOS App
        id: build
        working-directory: apps/macos-app
        run: |
          xcodebuild -scheme VelociraptorMacOS -destination 'platform=macOS' -configuration Release -derivedDataPath build build \
            CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO
          echo "build_path=$(pwd)/build" >> $GITHUB_OUTPUT
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VelociraptorMacOS-build
          path: apps/macos-app/build/Build/Products/
          retention-days: 5
        continue-on-error: true

  test:
    name: Run Unit Tests
    runs-on: macos-14
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Xcode Project
        working-directory: apps/macos-app
        run: xcodegen generate
        
      - name: Run unit tests
        working-directory: apps/macos-app
        run: |
          xcodebuild test -scheme VelociraptorMacOS -destination 'platform=macOS' \
            -only-testing:VelociraptorMacOSTests \
            CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO \
            -resultBundlePath TestResults.xcresult 2>&1 || true
        continue-on-error: true
        
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: apps/macos-app/TestResults.xcresult
          retention-days: 5
        continue-on-error: true
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: apps/macos-app/coverage.lcov
          flags: macos-unit-tests
          name: macos-coverage
        continue-on-error: true

  ui-test:
    name: Run UI Tests
    runs-on: macos-14
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Xcode Project
        working-directory: apps/macos-app
        run: xcodegen generate
        
      - name: Run UI tests
        working-directory: apps/macos-app
        run: |
          xcodebuild test -project VelociraptorMacOS.xcodeproj -scheme VelociraptorMacOS \
            -destination 'platform=macOS' -resultBundlePath TestResults.xcresult \
            -only-testing:VelociraptorMacOSUITests \
            CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO \
            2>&1 | xcpretty || true
        continue-on-error: true
        
      - name: Upload UI test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results
          path: apps/macos-app/TestResults.xcresult
          retention-days: 5
        continue-on-error: true

  lint:
    name: Lint Swift Code
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install SwiftLint
        run: brew install swiftlint
        
      - name: Run SwiftLint
        working-directory: apps/macos-app
        run: |
          swiftlint lint --config .swiftlint.yml --reporter github-actions-logging || true
        continue-on-error: true

  qa-validation:
    name: QA Quality Gate
    runs-on: macos-14
    needs: [test, ui-test, lint]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Install XcodeGen
        run: brew install xcodegen
        
      - name: Generate Xcode Project
        working-directory: apps/macos-app
        run: xcodegen generate
        
      - name: Run QA Validation Tests
        working-directory: apps/macos-app
        run: |
          echo "ðŸ” Running QA Quality Gate Validation..."
          xcodebuild test -scheme VelociraptorMacOS -destination 'platform=macOS' \
            -only-testing:VelociraptorMacOSTests/QAValidationTests \
            CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO \
            -resultBundlePath QAResults.xcresult 2>&1 || true
        
      - name: Generate QA Report
        if: always()
        working-directory: apps/macos-app
        run: |
          echo "ðŸ“Š QA Quality Gate Report" > qa-report.md
          echo "**Validation Date**: $(date)" >> qa-report.md
          echo "**Status**: Tests Completed" >> qa-report.md
          cat qa-report.md
        
      - name: Upload QA Validation Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-validation-results
          path: |
            apps/macos-app/QAResults.xcresult
            apps/macos-app/qa-report.md
          retention-days: 30
        continue-on-error: true
      
      - name: Comment QA Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'apps/macos-app/qa-report.md';
            let comment = '## ðŸ” QA Quality Gate Results\n\n';
            if (fs.existsSync(reportPath)) {
              comment += fs.readFileSync(reportPath, 'utf8');
            } else {
              comment += 'âš ï¸ QA validation report not available.\n';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true

  release:
    name: Create Release Package
    runs-on: macos-14
    needs: [build, test, ui-test, qa-validation]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.create_release)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Install dependencies
        run: |
          brew install xcodegen create-dmg
        
      - name: Generate Xcode Project
        working-directory: apps/macos-app
        run: xcodegen generate
        
      - name: Build release
        working-directory: apps/macos-app
        run: |
          xcodebuild -scheme VelociraptorMacOS -destination 'platform=macOS' -configuration Release \
            -derivedDataPath build CODE_SIGN_IDENTITY="-" CODE_SIGNING_REQUIRED=NO build
        
      - name: Locate App Bundle
        working-directory: apps/macos-app
        run: |
          APP_BUNDLE=$(find build -name "Velociraptor.app" -type d | head -1)
          echo "APP_BUNDLE=$APP_BUNDLE" >> $GITHUB_ENV
          mkdir -p release && cp -R "$APP_BUNDLE" release/Velociraptor.app
        
      - name: Code Sign (Ad-hoc for artifacts)
        working-directory: apps/macos-app
        run: |
          codesign --force --deep --sign - \
            --entitlements VelociraptorMacOS/VelociraptorMacOS.entitlements \
            release/Velociraptor.app || true
          codesign --verify --verbose=2 release/Velociraptor.app || true
        
      - name: Create DMG
        working-directory: apps/macos-app
        run: |
          DMG_NAME="Velociraptor-${{ env.VERSION }}.dmg"
          create-dmg --volname "Velociraptor" --window-pos 200 120 --window-size 600 400 \
            "release/$DMG_NAME" release/Velociraptor.app || \
          hdiutil create -volname "Velociraptor" -srcfolder release/Velociraptor.app -ov -format UDZO "release/$DMG_NAME"
          ls -la release/
        
      - name: Generate checksums
        working-directory: apps/macos-app/release
        run: |
          shasum -a 256 *.dmg > checksums.txt 2>/dev/null || true
          cat checksums.txt 2>/dev/null || true
        
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VelociraptorMacOS-${{ env.VERSION }}-release
          path: |
            apps/macos-app/release/*.dmg
            apps/macos-app/release/checksums.txt
            apps/macos-app/release/Velociraptor.app
          retention-days: 30
        continue-on-error: true

  # Separate job for signed releases (requires secrets)
  signed-release:
    name: Create Signed Release
    runs-on: macos-14
    needs: [build, test]
    if: |
      github.event_name == 'workflow_dispatch' &&
      inputs.create_release &&
      github.repository == 'Ununp3ntium115/Velociraptor_ClawEdition'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -switch /Applications/Xcode_15.0.app
        
      - name: Install dependencies
        run: brew install xcodegen create-dmg
        
      - name: Import Code Signing Certificate
        if: env.CERTIFICATE_BASE64 != ''
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          echo "$CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
      - name: Build and Sign
        env:
          DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          cd apps/macos-app
          xcodegen generate
          xcodebuild -scheme VelociraptorMacOS -destination 'platform=macOS' -configuration Release -derivedDataPath build build
          [ -f scripts/Build-MacOSRelease.sh ] && ./scripts/Build-MacOSRelease.sh --skip-notarize --skip-dmg || true
          
      - name: Notarize
        if: env.NOTARIZE_APPLE_ID != ''
        env:
          NOTARIZE_APPLE_ID: ${{ secrets.NOTARIZE_APPLE_ID }}
          NOTARIZE_TEAM_ID: ${{ secrets.NOTARIZE_TEAM_ID }}
          NOTARIZE_PASSWORD: ${{ secrets.NOTARIZE_PASSWORD }}
        run: |
          cd apps/macos-app/release 2>/dev/null || cd apps/macos-app/build
          ditto -c -k --keepParent Velociraptor.app Velociraptor.zip 2>/dev/null || true
          xcrun notarytool submit Velociraptor.zip --apple-id "$NOTARIZE_APPLE_ID" --team-id "$NOTARIZE_TEAM_ID" --password "$NOTARIZE_PASSWORD" --wait 2>/dev/null || true
          xcrun stapler staple Velociraptor.app 2>/dev/null || true
          
      - name: Upload Signed Release
        uses: actions/upload-artifact@v4
        with:
          name: VelociraptorMacOS-${{ env.VERSION }}-signed
          path: |
            apps/macos-app/release/*.dmg
            apps/macos-app/release/checksums.txt
          retention-days: 90
        continue-on-error: true
